/*! Stamplay v1.3.0 | (c) 2015 The Stamplay Dreamteam */

!function(a){function b(a){return decodeURIComponent((new RegExp("[?|&]"+a+"=([^&;]+?)(&|#|;|$)").exec(location.search)||[,""])[1].replace(/\+/g,"%20"))||null}a.Stamplay=a.Stamplay||{},a.Stamplay.VERSION="v1",Q.stopUnhandledRejectionTracking(),a.Stamplay.APPID="",a.Stamplay.BASEURL="",window.localStorage&&store.enabled&&(a.Stamplay.USESTORAGE=!0),b("jwt")&&Stamplay.USESTORAGE&&store.set(window.location.origin+"-jwt",b("jwt")),a.Stamplay.init=function(b){a.Stamplay.BASEURL="https://"+b+".stamplayapp.com",a.Stamplay.APPID=b}}(this),function(a){function b(a){var b=a.getResponseHeader("x-stamplay-jwt");if(b){var d=c(b);Stamplay.USESTORAGE&&store.set(window.location.origin+"-jwt",b)}return d}function c(a){var b={},c={},e="";try{var f=a.split(".");b=JSON.parse(d(f[0]||"{}")),c=JSON.parse(d(f[1]||"{}")),e=f[2]}catch(g){}return{header:b,claims:c,signature:e}}function d(a){return"undefined"!=typeof atob?atob(a):e(a)}function e(a){var b,c,d,e,f={},g=0,h=0,i="",j=String.fromCharCode,k=a.length,l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(b=0;64>b;b++)f[l.charAt(b)]=b;for(d=0;k>d;d++)for(c=f[a.charAt(d)],g=(g<<6)+c,h+=6;h>=8;)((e=g>>>(h-=8)&255)||k-2>d)&&(i+=j(e));return i}function f(a){var b,d,e=c(a).claims,f=Math.floor((new Date).getTime()/1e3);return"object"==typeof e&&(e.hasOwnProperty("iat")&&(b=e.iat),d=e.hasOwnProperty("exp")?e.exp:b+86400),f&&b&&d&&f>=b&&d>=f}var g=function(a){for(var b=Object.keys(a.thisParams),c=0;c<b.length;c++){var d=c>0?"&":"?",e=b[c];a.url=a.url+d+e+"="+a.thisParams[e]}},h=function(a,b){for(var c=0;c<a.length;c++){var d=a[c].split(";");if(2!=d.length)throw new Error("section could not be split on ';'");var e=d[0].replace(/<(.*)>/,"$1").trim(),f=d[1].replace(/rel="(.*)"/,"$1").trim();e.indexOf("&sort=")<0&&(e+="&sort=-dt_create"),b[f]=e}};a.Stamplay.makeAPromise=function(c,d){c.thisParams&&g(c);var e;""!=a.Stamplay.APPID?(c.url=a.Stamplay.BASEURL+c.url,e=a.Stamplay.APPID):(e=location.host,e=e.replace(/^www\./,""),e=e.replace(/:[0-9]*$/g,""));var i=Q.defer(),j=new XMLHttpRequest;if(j.open(c.method||"GET",c.url,c.async||!0),Object.keys(c.headers||{}).forEach(function(a){j.setRequestHeader(a,c.headers[a])}),j.setRequestHeader("Content-Type","application/json"),j.setRequestHeader("stamplay-app",e),Stamplay.USESTORAGE){var k=store.get(window.location.origin+"-jwt");k&&(f(k)?j.setRequestHeader("x-stamplay-jwt",k):store.remove(window.location.origin+"-jwt"))}return j.onreadystatechange=function(){if(4===j.readyState)if(-1===[200,304].indexOf(j.status))i.reject(j);else{var a=JSON.parse(j.responseText);if(b(j),d&&j.getResponseHeader("link")){var c=j.getResponseHeader("link").split(",");a.pagination={},h(c,a.pagination),a.totalElements=j.getResponseHeader("x-total-elements"),i.resolve(a)}else i.resolve(a)}},j.send(JSON.stringify(c.data)||void 0),i.promise},a.Stamplay.removeAttributes=function(a,b){switch(a){case"cobject":delete b.__v,delete b.cobjectId,delete b.actions,delete b.appId,delete b.id;break;case"user":delete b._id,delete b.id,delete b.__v}}}(this),function(a){function b(){var a=function(a,b){var c=this;return b?Stamplay.makeAPromise({method:"PUT",data:{type:b},url:"/api/"+this.brickId+"/"+Stamplay.VERSION+"/"+this.resourceId+"/"+this.instance._id+"/"+a}).then(function(a){c.instance=a}):Stamplay.makeAPromise({method:"PUT",url:"/api/"+this.brickId+"/"+Stamplay.VERSION+"/"+this.resourceId+"/"+this.instance._id+"/"+a}).then(function(a){c.instance=a})};this.upVote=function(){return a.call(this,"vote","upvote")},this.downVote=function(){return a.call(this,"vote","downvote")},this.rate=function(a){var b=this;if(parseInt(a))return Stamplay.makeAPromise({method:"PUT",data:{rate:a},url:"/api/"+this.brickId+"/"+Stamplay.VERSION+"/"+this.resourceId+"/"+this.instance._id+"/rate"}).then(function(a){b.instance=a});throw new Error("vote parameter to rate function must be a integer")},this.comment=function(a){var b=this;return Stamplay.makeAPromise({method:"PUT",data:{text:a},url:"/api/"+this.brickId+"/"+Stamplay.VERSION+"/"+this.resourceId+"/"+this.instance._id+"/comment"}).then(function(a){b.instance=a})},this.twitterShare=function(){return a.call(this,"twitter_share")},this.facebookShare=function(){return a.call(this,"facebook_share")},this.getComments=function(){return this.get("actions").comments},this.getVotes=function(a){return!a||"up"!==a&&"down"!==a?this.get("actions").votes.users:this.get("actions").votes["users_"+a+"vote"]},this.getRatings=function(){return this.get("actions").ratings.users},this.getTwitterShares=function(){return this.get("actions").twitter_shares.users},this.getFacebookShares=function(){return this.get("actions").facebook_shares.users}}function c(a,c,d){this.instance={},this.brickId=a,this.resourceId=c;var e={keys:1,values:1,pairs:1,invert:1,pick:0,omit:0,chain:1,isEmpty:1};g(this,e,"instance"),d&&b.call(this),this.constructor=function(a){this.instance={};for(var b=Object.keys(a),c=0,d=b.length;d>c;c++){var e=b[c],f=a[e];this.set(e,f)}return this},this.get=function(a){return this.instance[a]},this.set=function(a,b){this.instance[a]=b},this.unset=function(a){delete this.instance[a]},this.fetch=function(a,b){b=b||{};var c=this;return Stamplay.makeAPromise({method:"GET",url:"/api/"+this.brickId+"/"+Stamplay.VERSION+"/"+this.resourceId+"/"+a,thisParams:b}).then(function(a){c.instance=a})},this.save=function(a){a=a||{};var b=function(){return a.patch?"PATCH":"PUT"};if(this.instance){var c=this.instance._id?b():"POST",d="/api/"+this.brickId+"/"+Stamplay.VERSION+"/"+this.resourceId;("PATCH"===c||"PUT"===c)&&(d=d+"/"+this.get("_id"),Stamplay.removeAttributes(this.brickId,this.instance));var e=this;return Stamplay.makeAPromise({method:c,url:d,data:this.instance}).then(function(a){e.instance=a})}},this.destroy=function(){var a="user"===this.brickId;return this.get("_id")?Stamplay.makeAPromise({method:"DELETE",url:"/api/"+this.brickId+"/"+Stamplay.VERSION+"/"+this.resourceId+"/"+this.get("_id")}).then(function(b){if(a&&Stamplay.USESTORAGE){var c=store.get(window.location.origin+"-jwt");c&&store.remove(window.location.origin+"-jwt")}return b}):!1}}function d(b,c){this.instance=[],this.brickId=b,this.resourceId=c,this.length=this.instance.length,this.totalElement=0,this.link={},this.currentQuery={};var d=function(a){var b={};for(var c in a)if("find"===c)for(var d in a[c])b[d]=a[c][d];else"limit"===c?b.n=a[c]:"select"===c?b.select=a[c].join(","):"sort"===c?b.sort=a[c]:"pagination"===c?(b.page=a[c][0],b.per_page=a[c][1]):"populate"===c?b.populate=!0:"populateOwner"===c&&(b.populate_owner=!0);return b};this.compile=function(){return d(this.currentQuery)},this.populate=function(){return this.currentQuery.populate=!0,this},this.populateOwner=function(){return this.currentQuery.populateOwner=!0,this},this.pagination=function(a,b){if(!a||!b)throw new Error("Pagination want two parameters");return this.currentQuery.pagination=[a,b],this},this.equalTo=function(a,b){if(this.currentQuery.find||(this.currentQuery.find={}),"object"==typeof a)for(var c in a)this.currentQuery.find[c]=a[c];else this.currentQuery.find[a]=b;return this},this.limit=function(a){return this.currentQuery.limit=a,this},this.select=function(a){if(this.currentQuery.select||(this.currentQuery.select=[]),a instanceof Array)for(var b=0;b<a.length;b++)this.currentQuery.select.push(a[b]);else this.currentQuery.select.push(a);return this},this.sortAscending=function(a){return this.currentQuery.sort=a,this},this.sortDescending=function(a){return this.currentQuery.sort="-"+a,this};var e={forEach:3,each:3,map:3,collect:3,reduce:4,foldl:4,inject:4,reduceRight:4,foldr:4,find:3,detect:3,filter:3,reject:3,every:3,all:3,some:3,any:3,include:2,contains:2,invoke:2,max:3,min:3,toArray:1,size:1,first:3,head:3,take:3,initial:3,rest:3,tail:3,drop:3,last:3,without:0,difference:0,indexOf:3,shuffle:1,lastIndexOf:3,isEmpty:1,chain:1,sample:3,partition:3};g(this,e,"instance"),this.get=function(a){for(var b=0,c=this.instance.length;c>b;b++)if(this.instance[b].get("_id")==a)return this.instance[b]},this.at=function(a){return this.instance[a]},this.pop=function(){var a=this.instance[this.instance.length-1];return 0!=this.instance.length?(this.remove(a.get("_id")),a):!1},this.shift=function(){var a=this.instance[0];return a?(this.remove(a.get("_id")),a):!1},this.add=function(a){a instanceof Object&&a.brickId==this.brickId&&a.get("_id")&&("cobject"==a.brickId?a.resourceId==this.resourceId&&(this.instance.push(a),this.length=this.instance.length):(this.instance.push(a),this.length=this.instance.length))},this.count=function(){return this.totalElements},this.set=function(b){if(!(b instanceof Array))throw new Error("Set method on Collection wants an Array");var c=this;b.forEach(function(b){if(b instanceof Object){var d;if("cobject"==c.brickId)d=new a.Stamplay.Cobject(c.resourceId),d=d.Model.constructor(b);else{var e=c.brickId.charAt(0).toUpperCase()+c.brickId.slice(1);d=new a.Stamplay[e],d=d.Model.constructor(b)}c.instance.push(d)}}),c.length=c.instance.length},this.fetch=function(b){b=b&&_.extend(b,this.compile())||this.compile();var c=this;if("cobject"===c.brickId)var d=!0;return Stamplay.makeAPromise({method:"GET",url:"/api/"+this.brickId+"/"+Stamplay.VERSION+"/"+this.resourceId,thisParams:b},d).then(function(b){b.totalElements&&b.pagination&&(c.totalElements=parseInt(b.totalElements),c.pagination=b.pagination),c.instance=[],b.data.forEach(function(b){var d;if("cobject"===c.brickId)d=new a.Stamplay.Cobject(c.resourceId),d=d.Model.constructor(b);else{var e=c.brickId.charAt(0).toUpperCase()+c.brickId.slice(1);d=new a.Stamplay[e],d=d.Model.constructor(b)}c.instance.push(d)}),c.length=c.instance.length})},this.remove=function(a){a instanceof Array?(this.instance=_.reject(this.instance,function(b){for(var c in a)if(b.get("_id")==a[c])return!0},this),this.length=this.instance.length):(this.instance=_.reject(this.instance,function(b){return b.get("_id")==a?!0:void 0},this),this.length=this.instance.length)}}function e(a,b,e){this.Model={},this.Collection={},c.call(this.Model,a,b,e),d.call(this.Collection,a,b)}var f=function(a,b,c){switch(a){case 1:return function(){return _[b](this[c])};case 2:return function(a){return _[b](this[c],a)};case 3:return function(a,d){return _[b](this[c],a,d)};case 4:return function(a,d,e){return _[b](this[c],a,d,e)};default:return function(){var a=Array.prototype.slice.call(arguments);return a.unshift(this[c]),_[b].apply(_,a)}}},g=function(a,b,c){_.each(b,function(b,d){_[d]&&(a[d]=f.call(a,b,d,c))})};a.Stamplay.BaseComponent=e}(this),function(a){function b(){this.redirect=function(a){window.location.href=a},this.validateEmail=function(a){return Stamplay.makeAPromise({method:"POST",data:{email:a},url:"/api/auth/"+Stamplay.VERSION+"/validate/email"})},this.checkMongoId=function(a){var b=new RegExp("^[0-9a-fA-F]{24}$"),c="string"==typeof a&&b.test(a);return c},this.errorSender=function(a,b){var c=Q.defer();return c.reject({status:a,message:b}),c.promise}}var c=new b;a.Stamplay.Support=c}(this),function(a){function b(b,c){this.model=b,this.instance=c,this.currentQuery=[],this.executable="",this.or=function(){var b={$or:[]};arguments[0]instanceof Array&&(arguments=arguments[0]);for(var c=0;c<arguments.length;c++){if(!(arguments[c]instanceof a.Stamplay.Query))throw new Error("Please Or function take only Query object");b.$or.push(arguments[c].currentQuery[0])}return this.currentQuery.push(b),this},this.between=function(a,b,c){var d={};return d[a]={$gte:b,$lte:c},this.currentQuery.push(d),this},this.greaterThan=function(a,b){var c={};return c[a]={$gt:b},this.currentQuery.push(c),this},this.greaterThanOrEqual=function(a,b){var c={};return c[a]={$gte:b},this.currentQuery.push(c),this},this.lessThan=function(a,b){var c={};return c[a]={$lt:b},this.currentQuery.push(c),this},this.lessThanOrEqual=function(a,b){var c={};return c[a]={$lte:b},this.currentQuery.push(c),this},this.equalTo=function(a,b){var c={};return c[a]=b,this.currentQuery.push(c),this},this.sortAscending=function(a){var b={$sort:{}};return b.$sort[a]=1,this.currentQuery.push(b),this},this.sortDescending=function(a){var b={$sort:{}};return b.$sort[a]=-1,this.currentQuery.push(b),this},this.exists=function(a){var b={};return b[a]={$exists:!0},this.currentQuery.push(b),this},this.notExists=function(a){var b={};return b[a]={$exists:!1},this.currentQuery.push(b),this},this.exec=function(){for(var a=0;a<this.currentQuery.length;a++){var b=JSON.stringify(this.currentQuery[a]);b=b.substring(1,b.length-1),0===a?this.executable+=b:this.executable+=","+b}return this.instance||(this.instance=this.model+"s"),Stamplay.makeAPromise({method:"GET",url:"/api/"+this.model+"/"+Stamplay.VERSION+"/"+this.instance+"?where={"+this.executable+"}"}).then(function(a){return a.data})}}a.Stamplay.Query=b}(this),function(a){function b(){Stamplay.BaseComponent.call(this,"user","users"),this.Model.currentUser=function(){var a=this;return Stamplay.makeAPromise({method:"GET",url:"/api/"+this.brickId+"/"+Stamplay.VERSION+"/getStatus"}).then(function(b){a.instance=b.user||{}})},this.Model.isLogged=function(){return this.instance._id?!0:!1},this.Model.login=function(b,c){var d=this;if(c){var e={email:b,password:c};return Stamplay.makeAPromise({method:"POST",data:e,url:"/auth/"+Stamplay.VERSION+"/local/login"}).then(function(a){d.instance=a||{}})}var f=store.get(window.location.origin+"-jwt");if(f){var g=new Date;g.setTime(g.getTime()+3e5),document.cookie="stamplay.jwt="+f+"; expires="+g.toGMTString()+"; path=/"}var h="/auth/"+Stamplay.VERSION+"/"+b+"/connect",i=window.location.port?":"+window.location.port:"";a.Stamplay.Support.redirect(location.protocol+"//"+document.domain+i+h)},this.Model.signup=function(a){if(a.email&&a.password){var b=this;return Stamplay.makeAPromise({method:"POST",data:a,url:"/api/"+this.brickId+"/"+Stamplay.VERSION+"/"+this.resourceId}).then(function(a){b.instance=a||{}})}throw new Error("Stamplay.User.Model.signup(data) needs that data object has the email and password keys")},this.Model.logout=function(){Stamplay.USESTORAGE&&store.remove(window.location.origin+"-jwt"),a.Stamplay.Support.redirect("/auth/"+Stamplay.VERSION+"/logout")},this.Model.resetPassword=function(a,b){return a&&b?Stamplay.makeAPromise({method:"POST",data:{email:a,newPassword:b},url:"/api/"+this.brickId+"/"+Stamplay.VERSION+"/users/resetpassword"}).then(function(a){return a}):Stamplay.Support.errorSender(403,"Missing parameters in resetPassword method")},this.Model.activities=function(a){return Stamplay.makeAPromise({method:"GET",url:"/api/"+this.brickId+"/"+Stamplay.VERSION+"/users/"+a+"/activities"}).then(function(a){return a})},this.Model.following=function(a){return Stamplay.makeAPromise({method:"GET",url:"/api/"+this.brickId+"/"+Stamplay.VERSION+"/users/"+a+"/following"}).then(function(a){return a})},this.Model.followedBy=function(a){return Stamplay.makeAPromise({method:"GET",url:"/api/"+this.brickId+"/"+Stamplay.VERSION+"/users/"+a+"/followed_by"}).then(function(a){return a})},this.Model.follow=function(a){return Stamplay.makeAPromise({method:"PUT",data:{userId:a},url:"/api/"+this.brickId+"/"+Stamplay.VERSION+"/users/follow"}).then(function(a){return a})},this.Model.unfollow=function(a){return Stamplay.makeAPromise({method:"PUT",data:{userId:a},url:"/api/"+this.brickId+"/"+Stamplay.VERSION+"/users/unfollow"}).then(function(a){return a})}}a.Stamplay.User=b}(this),function(a){function b(b){Stamplay.BaseComponent.call(this,"cobject",b,!0),this.Collection.findByAttr=function(b){if(b){var c=this;return Stamplay.makeAPromise({method:"GET",url:"/api/"+this.brickId+"/"+Stamplay.VERSION+"/"+this.resourceId+"/find/"+b}).then(function(b){b.totalElements&&b.pagination&&(c.totalElements=parseInt(b.totalElements),c.pagination=b.pagination),c.instance=[],b.data.forEach(function(b){var d=new a.Stamplay.Cobject(c.resourceId);d=d.Model.constructor(b),c.instance.push(d)}),c.length=c.instance.length})}return Stamplay.Support.errorSender(403,"Missing parameter in findByAttr method")}}a.Stamplay.Cobject=b}(this),function(a){function b(a){var b=a.replace(/[^\w\s]/gi,"").trim().toLowerCase().replace(/\s+/g,"_");this.url="/api/webhook/"+Stamplay.VERSION+"/"+b+"/catch",this.post=function(a,b){return Stamplay.makeAPromise({method:"POST",data:a,url:this.url,thisParams:b})},this.put=function(a,b){return Stamplay.makeAPromise({method:"PUT",data:a,url:this.url,thisParams:b})},this.get=function(a){return Stamplay.makeAPromise({method:"GET",url:this.url,thisParams:a})}}a.Stamplay.Webhook=b}(this),function(a){function b(){this.url="/api/stripe/"+Stamplay.VERSION+"/",this.createCustomer=function(a){return Stamplay.Support.checkMongoId(a)?Stamplay.makeAPromise({method:"POST",data:{userId:a},url:this.url+"customers"}):Stamplay.Support.errorSender(403,"Invalid userId")},this.createCreditCard=function(a,b){return 2==arguments.length?Stamplay.Support.checkMongoId(a)?Stamplay.makeAPromise({method:"POST",data:{token:b},url:this.url+"customers/"+a+"/cards"}):Stamplay.Support.errorSender(403,"Invalid userId"):Stamplay.Support.errorSender(403,"Missing parameters in createCreditCard methods")},this.updateCreditCard=function(a,b){return 2==arguments.length?Stamplay.Support.checkMongoId(a)?Stamplay.makeAPromise({method:"PUT",data:{token:b},url:this.url+"customers/"+a+"/cards"}):Stamplay.Support.errorSender(403,"Invalid userId"):Stamplay.Support.errorSender(403,"Missing parameters in updateCreditCard methods")},this.charge=function(a,b,c,d){return 4==arguments.length?Stamplay.Support.checkMongoId(a)?Stamplay.makeAPromise({method:"POST",data:{userId:a,token:b,amount:c,currency:d},url:this.url+"charges"}):Stamplay.Support.errorSender(403,"Invalid userId"):Stamplay.Support.errorSender(403,"Missing parameters in charge methods")},this.createSubscription=function(a,b){return 2===arguments.length?Stamplay.Support.checkMongoId(a)?Stamplay.makeAPromise({method:"POST",data:{planId:b},url:this.url+"customers/"+a+"/subscriptions"}):Stamplay.Support.errorSender(403,"Invalid userId"):Stamplay.Support.errorSender(403,"Missing parameters in createSubscription methods")},this.getSubscriptions=function(a,b){return arguments.length>=1?Stamplay.Support.checkMongoId(a)?Stamplay.makeAPromise({method:"GET",url:this.url+"customers/"+a+"/subscriptions",thisParams:b}):Stamplay.Support.errorSender(403,"Invalid userId"):Stamplay.Support.errorSender(403,"Missing parameters in getSubscriptions methods")},this.getSubscription=function(a,b){return arguments.length<=2?Stamplay.Support.checkMongoId(a)?Stamplay.makeAPromise({method:"GET",url:this.url+"customers/"+a+"/subscriptions/"+b}):Stamplay.Support.errorSender(403,"Invalid userId"):Stamplay.Support.errorSender(403,"Missing parameters in getSubscription methods")},this.getCreditCard=function(a){return 1==arguments.length?Stamplay.Support.checkMongoId(a)?Stamplay.makeAPromise({method:"GET",url:this.url+"customers/"+a+"/cards"}):Stamplay.Support.errorSender(403,"Invalid userId"):Stamplay.Support.errorSender(403,"Invalid parameter in getCreditCard method")},this.deleteSubscription=function(a,b,c){return 2===arguments.length?Stamplay.Support.checkMongoId(a)?Stamplay.makeAPromise({method:"DELETE",url:this.url+"customers/"+a+"/subscriptions/"+b,data:c||{}}):Stamplay.Support.errorSender(403,"Invalid userId"):Stamplay.Support.errorSender(403,"Missing parameters in deleteSubscription methods")},this.updateSubscription=function(a,b,c){return arguments.length>=2?Stamplay.Support.checkMongoId(a)?(c=c||{},Stamplay.makeAPromise({method:"PUT",url:this.url+"customers/"+a+"/subscriptions/"+b,data:{options:c}})):Stamplay.Support.errorSender(403,"Invalid userId"):Stamplay.Support.errorSender(403,"Missing parameters in updateSubscription methods")}}a.Stamplay.Stripe=b}(this),function(a){function b(a){function b(a){var b="POST";if("string"==typeof a)switch(a){case"GET":case"POST":case"PUT":case"PATCH":case"DELETE":b=a;break;default:return Stamplay.Support.errorSender(403,"Invalid HTTP verb: available verbs are GET,POST,PUT,PATCH and DELETE")}return b}function c(a,b){var c=null==b||void 0==b?void 0:b;switch(a){case"POST":case"PUT":case"PATCH":break;default:c=void 0}return c}var d=a.replace(/[^\w\s]/gi,"").trim().toLowerCase().replace(/\s+/g,"_");this.url="/api/codeblock/"+Stamplay.VERSION+"/run/"+d,this.run=function(a,d){var e=b("POST"),f=c("POST",a);return Stamplay.makeAPromise({method:e,data:f,url:this.url,thisParams:d})}}a.Stamplay.Codeblock=b}(this);
//# sourceMappingURL=stamplay.min.js.map